name: PR Automation

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-label:
    name: Auto-label PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45

      - name: Add labels based on changed files
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const labels = new Set();

            for (const file of changedFiles) {
              if (file.startsWith('docs/')) {
                labels.add('documentation');
              }
              if (file.startsWith('src/')) {
                labels.add('frontend');
              }
              if (file.startsWith('blog/')) {
                labels.add('blog');
              }
              if (file.startsWith('.github/')) {
                labels.add('ci/cd');
              }
              if (file.endsWith('.css') || file.endsWith('.scss')) {
                labels.add('styles');
              }
              if (file.endsWith('.md') || file.endsWith('.mdx')) {
                labels.add('content');
              }
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }

  welcome-contributor:
    name: Welcome first-time contributor
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Check if first-time contributor
        id: first-time
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;

            // Get all PRs by this author
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 2
            });

            const authorPrs = prs.filter(pr => pr.user.login === author);
            const isFirstTime = authorPrs.length <= 1;

            core.setOutput('is_first_time', isFirstTime);
            return isFirstTime;

      - name: Welcome message
        if: steps.first-time.outputs.is_first_time == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;

            const message = `## Welcome @${author}!

            Thank you for your first contribution to this project! We appreciate you taking the time to help improve our documentation and code.

            ### What happens next?
            - A maintainer will review your changes
            - The CI checks will run automatically
            - Feel free to ask questions if you need any help

            Thanks for being part of the community! :rocket:`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

  pr-size-label:
    name: Label PR size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR size and add label
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR diff stats
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            // Remove existing size labels
            const existingLabels = pr.labels.map(l => l.name);
            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];

            for (const label of sizeLabels) {
              if (existingLabels.includes(label)) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label
                  });
                } catch (e) {
                  // Label might not exist, ignore error
                }
              }
            }

            // Determine size label
            let sizeLabel;
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 200) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
